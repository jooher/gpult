<!doctype html>
<style>
label{display:block; margin:2em;}
label>input{display:block; }
</style>

<body>
	<svg width="800" height="400" viewBox="0 100 800 400" transform="scale(1 -1)">
		<path id=shape fill="#cce" d="M 40,300 55,375 338,465 236,349 202,133 103,245 z" />
		<path id=route style="stroke:black; stroke-width:1px; fill:none"/>
		<path id=tpath />
	</svg>
	
	<script src="maths-rel.js"></script>
	
	<form onchange="update(this)" >
		<label>tool
			<input name=tool type=range min=0 max=10 value=2 />
		</label>
		<label>allowance
			<input name=allowance type=range min=0 max=10 value=1 />
		</label>
		<label>tolerance
			<input name=tolerance type=range min=1 max=10 value=1 />
		</label>
	</form>
	
	<form onchange="run()" >
		<label>A: um/ms2 = m/s2 (10 for 1G)<input name="A" type=range value=10 min=1 max=100 step=1 /></label>
		<label>V: um/ms = mm/s (1000 for 1 m/s)<input name="V" type=range value=100 min=10 max=1000 step=10 /></label>
	</form>
	
	<script>
	"use strict";
	
	let
		geometry,
		plan;

	const
	
	prepareRouter = setup => ((offset,smooth) => corners => offset(corners)/*smooth()*/)(offset(setup),smooth(setup)),
	
	svg2corners = d => {
		const
		
		corners = d
			.split(" ")
			.filter(str=>str.match(/^[0-9.,\-]+$/))
			.map(str=>str.split(","))
			.map(([x,y])=>( {x:1.0*x, y:1.0*y, r:0} ));
		
		if("z")corners.push(corners[0]);
		
		return corners;
	},
	
	abs2svg = route => "\nm " + route
		.map(({lx,ly,ax,ay,r}) => [lx,ly,"a",r,r,0,0,Math.sign(r)>0?0:1,ax,ay].join(" "))
		.join("\nL "),
		
	rel2svg = ({ origin,edges}) => `\nM ${origin.dx} ${origin.dy}` + edges
		.map(({dx,dy,ax,ay,r=1}) => ["\nl", dx,dy].join(" "))//,"a",r,r,0,0,Math.sign(r)>0?0:1,ax,ay
		.join("");
	

const corners = svg2corners(document.getElementById("shape").getAttribute("d")),
	edges = corners2edges(corners),
	svgrel = rel2svg(edges);

document.getElementById("route").setAttribute("d",svgrel);
	
	
	const
	
	update = ( ({shapesvg,routesvg,tpathsvg}) => f => {
	
		const
			setup = Object.fromEntries(new FormData(f).entries().map(([name,value])=>[name,1*value])),
			router = prepareRouter(setup),
			route = router(shapesvg),
			d = rel2svg(route),
			
			plan = null;
		
		routesvg.setAttribute("d",d);
		tpathsvg.setAttribute("d",d);
		tpathsvg.setAttribute("style",`fill:none; stroke:rgba(0,180,0,.25); stroke-width:${setup.tool*2}px`);
	})({
		shapesvg: corners2edges(svg2corners(document.getElementById("shape").getAttribute("d"))),
		routesvg: document.getElementById("route"),
		tpathsvg: document.getElementById("tpath")
	}),
	
	run = () => {}
	

	</script>
</body>